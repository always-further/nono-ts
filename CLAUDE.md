# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Is

nono-ts is a napi-rs project that provides Node.js/TypeScript bindings for the [nono](https://github.com/always-further/nono) capability-based sandboxing library. It wraps the Rust `nono` crate into a native `.node` addon using napi-rs v2.

## Build Commands

```bash
npm run build          # Release build (napi build --platform --release)
npm run build:debug    # Debug build (napi build --platform)
npm test               # Run tests (node test.js)
cargo fmt --check      # Check Rust formatting
cargo clippy           # Lint Rust code
```

## Architecture

**Single-file Rust binding** (`src/lib.rs`): All napi-rs bindings live in one file. Each Rust type from the `nono` crate gets a `Js`-prefixed wrapper struct (e.g., `JsCapabilitySet` wraps `RustCapabilitySet`) exposed to JS via `#[napi(js_name = "CapabilitySet")]`.

**napi-rs codegen** (`index.js`, `index.d.ts`): These are generated by `@napi-rs/cli` and handle platform-specific native binary resolution. The binary packages follow the naming pattern `nono-ts-{platform}-{arch}`. Do not hand-edit these files; regenerate with `napi build`.

**Local path dependency**: `Cargo.toml` references `nono = { path = "../nono/crates/nono" }`. The sibling `../nono/` Rust workspace must be present to build. This package is intentionally not part of the main nono cargo workspace.

## Target Platforms

Defined in `package.json` under `napi.targets`:
- `x86_64-apple-darwin`, `aarch64-apple-darwin`
- `x86_64-unknown-linux-gnu`, `aarch64-unknown-linux-gnu`

## Key Patterns

- Rust enums/structs map to JS via `From` trait implementations (e.g., `AccessMode` conversion)
- Errors from the nono crate are mapped to napi errors in `to_napi_err()`, using `InvalidArg` for path validation errors and `GenericFailure` for everything else
- `#[napi(object)]` for plain data objects, `#[napi(getter)]` for computed properties
- `apply()` is irreversible â€” once the sandbox is applied, the process is permanently restricted
